<!DOCTYPE html>
<html>
<head>
  <title>Budget Tracker</title>
  <meta charset="UTF-8" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f2f5;
      max-width: 900px;
      margin: auto;
      padding: 30px;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
    }
    .form-section > div {
      flex: 1 1 45%;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #45a049;
    }
    .income-form button {
      background-color: #2196F3;
    }
    .income-form button:hover {
      background-color: #1e88e5;
    }
    .expense-form button {
      background-color: #f44336;
    }
    .expense-form button:hover {
      background-color: #e53935;
    }
    .income { color: green; }
    .expense { color: red; }
    canvas {
      margin-top: 20px;
    }
    #history {
      list-style-type: none;
      padding: 0;
    }
    #history li {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
  <!-- Firebase and Chart.js -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>üí∞ Budget Tracker</h2>

  <div class="card">
    <div id="authSection">
      <button id="loginBtn">üîê Login with Google</button>
      <button id="logoutBtn" style="display:none;">üö™ Logout</button>
    </div>
  </div>

  <div id="mainApp" style="display:none;">

    <div class="card income-form">
      <h3>‚ûï Add Income</h3>
      <form id="incomeForm" class="form-section">
        <div><input id="incomeDesc" placeholder="Description" required /></div>
        <div><input id="incomeAmount" type="number" placeholder="Amount" required /></div>
        <div><select id="incomeCategory" required>
          <option value="">-- Choose Category --</option>
          <option>Salary</option>
          <option>Investment</option>
          <option>Gift</option>
          <option>Other Income</option>
        </select></div>
        <div><button type="submit">Add Income</button></div>
      </form>
    </div>

    <div class="card expense-form">
      <h3>‚ûñ Add Expense</h3>
      <form id="expenseForm" class="form-section">
        <div><input id="expenseDesc" placeholder="Description" required /></div>
        <div><input id="expenseAmount" type="number" placeholder="Amount" required /></div>
        <div><select id="expenseCategory" required>
          <option value="">-- Choose Category --</option>
          <option>Food</option>
          <option>Transport</option>
          <option>Shopping</option>
          <option>Other Expense</option>
        </select></div>
        <div><button type="submit">Add Expense</button></div>
      </form>
    </div>

    <div class="card">
      <h3>üìÖ Filter by Month:</h3>
      <select id="monthFilter"></select>
    </div>

    <div class="card">
      <h3>üßæ Transaction History</h3>
      <ul id="history"></ul>
      <h3>üíº Total Balance: <span id="total">0</span></h3>
    </div>

    <div class="card">
      <h3>üßÅ Pie Chart (By Category)</h3>
      <canvas id="categoryChart" height="200"></canvas>
    </div>

    <div class="card">
      <h3>üìà Line Chart (Daily Totals)</h3>
      <canvas id="lineChart" height="200"></canvas>
    </div>

  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAXLjQptvknanK8CBKp7c23pIyeqZY_9ag",
      authDomain: "lazarius-ad2e6.firebaseapp.com",
      projectId: "lazarius-ad2e6",
      storageBucket: "lazarius-ad2e6.appspot.com",
      messagingSenderId: "615981652470",
      appId: "1:615981652470:web:fae653fc7d1e39e7e78fd7"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const mainApp = document.getElementById('mainApp');
    const monthFilter = document.getElementById('monthFilter');
    const history = document.getElementById('history');
    const totalDisplay = document.getElementById('total');

    let userId = null;
    let unsubscribe = null;
    let pieChart = null;
    let lineChart = null;

    loginBtn.onclick = () => {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider);
    };

    logoutBtn.onclick = () => auth.signOut();

    auth.onAuthStateChanged(user => {
      if (user) {
        userId = user.uid;
        loginBtn.style.display = 'none';
        logoutBtn.style.display = 'inline-block';
        mainApp.style.display = 'block';
        loadMonthFilter();
        listenToTransactions();
      } else {
        mainApp.style.display = 'none';
        loginBtn.style.display = 'inline-block';
        logoutBtn.style.display = 'none';
        if (unsubscribe) unsubscribe();
      }
    });

    document.getElementById("incomeForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const desc = document.getElementById("incomeDesc").value;
      const amount = parseFloat(document.getElementById("incomeAmount").value);
      const category = document.getElementById("incomeCategory").value;
      if (!desc || isNaN(amount) || !category) return;
      await db.collection("transactions").add({ userId, desc, amount, category, timestamp: new Date() });
      e.target.reset();
    });

    document.getElementById("expenseForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const desc = document.getElementById("expenseDesc").value;
      const amount = parseFloat(document.getElementById("expenseAmount").value);
      const category = document.getElementById("expenseCategory").value;
      if (!desc || isNaN(amount) || !category) return;
      await db.collection("transactions").add({ userId, desc, amount: -Math.abs(amount), category, timestamp: new Date() });
      e.target.reset();
    });

    function loadMonthFilter() {
      const now = new Date();
      for (let i = 0; i < 12; i++) {
        const d = new Date(now.getFullYear(), i);
        const value = `${d.getFullYear()}-${String(i + 1).padStart(2, '0')}`;
        const text = d.toLocaleString('default', { month: 'long', year: 'numeric' });
        const option = new Option(text, value);
        monthFilter.add(option);
      }
      monthFilter.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
    }

    monthFilter.addEventListener("change", () => {
      if (unsubscribe) unsubscribe();
      listenToTransactions();
    });

    function listenToTransactions() {
      const [year, month] = monthFilter.value.split("-");
      const start = new Date(year, month - 1);
      const end = new Date(year, month);

      unsubscribe = db.collection("transactions")
        .where("userId", "==", userId)
        .where("timestamp", ">=", start)
        .where("timestamp", "<", end)
        .orderBy("timestamp", "asc")
        .onSnapshot(snapshot => {
          history.innerHTML = "";
          let total = 0;
          const allData = [];
          snapshot.forEach(doc => {
            const d = doc.data();
            total += d.amount;
            allData.push(d);
            const li = document.createElement("li");
            li.className = d.amount >= 0 ? "income" : "expense";
            li.textContent = `${d.desc} (${d.category}): ${d.amount >= 0 ? '+' : ''}${d.amount}`;
            history.appendChild(li);
          });
          totalDisplay.textContent = total.toLocaleString();
          updateCategoryChart(allData);
          updateLineChart(allData);
        });
    }

    function updateCategoryChart(data) {
      const categoryTotals = {};
      data.forEach(({ category, amount }) => {
        if (!categoryTotals[category]) categoryTotals[category] = 0;
        categoryTotals[category] += amount;
      });
      const labels = Object.keys(categoryTotals);
      const values = Object.values(categoryTotals);
      if (pieChart) pieChart.destroy();
      pieChart = new Chart(document.getElementById("categoryChart"), {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: ['#4CAF50', '#F44336', '#2196F3', '#FF9800', '#9C27B0']
          }]
        }
      });
    }

    function updateLineChart(data) {
      const dailyTotals = {};
      data.forEach(({ timestamp, amount }) => {
        const date = new Date(timestamp.seconds * 1000).toISOString().split("T")[0];
        if (!dailyTotals[date]) dailyTotals[date] = 0;
        dailyTotals[date] += amount;
      });
      const dates = Object.keys(dailyTotals).sort();
      const values = dates.map(date => dailyTotals[date]);
      if (lineChart) lineChart.destroy();
      lineChart = new Chart(document.getElementById("lineChart"), {
        type: 'line',
        data: {
          labels: dates,
          datasets: [{
            label: "Daily Total",
            data: values,
            fill: false,
            borderColor: '#2196F3',
            tension: 0.2
          }]
        }
      });
    }
  </script>
</body>
</html>
